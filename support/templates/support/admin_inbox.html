<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Support Inbox - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body{background:linear-gradient(135deg,#0a0e27,#1a1f3a);color:#e0e0e0;min-height:100vh}
        .navbar{background:rgba(10,14,39,.95);border-bottom:1px solid rgba(0,212,255,.2)}
        .navbar-brand{font-weight:700;color:#00d4ff!important;font-size:1.5rem}
        .container-fluid{padding-top:2rem}
        .support-container{background:rgba(26,31,58,.7);border-radius:15px;padding:2rem;border:1px solid rgba(0,212,255,.2)}
        .thread-card{background:rgba(10,14,39,.6);border-radius:12px;padding:1.5rem;border:1px solid rgba(0,212,255,.2);margin-bottom:1rem;cursor:pointer;transition:all .3s}
        .thread-card:hover{border-color:rgba(0,212,255,.5);transform:translateY(-2px)}
        .thread-card.unread{border-left:4px solid #ff4444}
        .filter-btn{margin-right:.5rem;margin-bottom:.5rem}
        .stats-card{background:rgba(10,14,39,.6);border-radius:8px;padding:1rem;text-align:center}
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'signals:dashboard' %}"><i class="bi bi-shield-check"></i> ZenithEdge Admin</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="{% url 'support:admin_inbox' %}"><i class="bi bi-inbox"></i> Support Inbox 
                    {% if stats.unread > 0 %}<span class="badge bg-danger">{{ stats.unread }}</span>{% endif %}
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <h1 style="color:#00d4ff;margin-bottom:2rem"><i class="bi bi-inbox"></i> Support Inbox</h1>

        <div class="row mb-4">
            <div class="col-md-3"><div class="stats-card"><h3 style="color:#00d4ff">{{ stats.total }}</h3><p>Total Tickets</p></div></div>
            <div class="col-md-3"><div class="stats-card"><h3 style="color:#ffc107">{{ stats.open }}</h3><p>Open</p></div></div>
            <div class="col-md-3"><div class="stats-card"><h3 style="color:#ff4444">{{ stats.unread }}</h3><p>Unread</p></div></div>
            <div class="col-md-3"><div class="stats-card"><h3 style="color:#6c757d">{{ stats.closed }}</h3><p>Closed</p></div></div>
        </div>

        <div class="mb-3">
            <a href="?status=all" class="btn btn-sm {% if status_filter == 'all' %}btn-info{% else %}btn-outline-info{% endif %} filter-btn">All</a>
            <a href="?status=open" class="btn btn-sm {% if status_filter == 'open' %}btn-warning{% else %}btn-outline-warning{% endif %} filter-btn">Open</a>
            <a href="?status=unread" class="btn btn-sm {% if status_filter == 'unread' %}btn-danger{% else %}btn-outline-danger{% endif %} filter-btn">Unread</a>
            <a href="?status=closed" class="btn btn-sm {% if status_filter == 'closed' %}btn-secondary{% else %}btn-outline-secondary{% endif %} filter-btn">Closed</a>
        </div>

        <div class="support-container">
            {% for thread in threads %}
            <div class="thread-card {% if thread.has_unread_user_message %}unread{% endif %}" 
                 onclick="window.location.href='{% url 'support:admin_thread_detail' thread.id %}'">
                <div class="d-flex justify-content-between">
                    <div class="flex-grow-1">
                        <h5 style="color:#00d4ff">#{{ thread.id }} - {{ thread.subject }}
                            {% if thread.has_unread_user_message %}<span class="badge bg-danger ms-2">New</span>{% endif %}
                        </h5>
                        <small class="text-muted">
                            <i class="bi bi-person"></i> {{ thread.user.email }} | 
                            <i class="bi bi-clock"></i> {{ thread.last_message_at|date:"M d, Y H:i" }} |
                            <i class="bi bi-chat"></i> {{ thread.message_count }} messages
                            {% if thread.signal_id %}| <i class="bi bi-link"></i> Signal #{{ thread.signal_id }}{% endif %}
                        </small>
                    </div>
                    <span class="badge {% if thread.status == 'open' %}bg-warning{% elif thread.status == 'closed' %}bg-secondary{% else %}bg-info{% endif %}">
                        {{ thread.get_status_display }}
                    </span>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size:4rem;color:#00d4ff"></i>
                <h3 class="mt-3">No Tickets Found</h3>
            </div>
            {% endfor %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        setInterval(async () => {
            try {
                const response = await fetch('{% url "support:unread_count" %}');
                const data = await response.json();
                if (data.unread_count > {{ stats.unread }}) location.reload();
            } catch (error) {
                console.error('Error checking for new tickets');
            }
        }, 30000);
    </script>
</body>
</html>

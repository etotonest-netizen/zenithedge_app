{% load static %}
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutopsyLoop Analytics - ZenithEdge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
            min-height: 100vh;
        }
        
        .admin-sidebar {
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            height: 100vh;
            position: fixed;
            width: 260px;
            padding: 20px 0;
            overflow-y: auto;
        }
        
        .admin-content {
            margin-left: 260px;
            padding: 30px;
        }
        
        .sidebar-brand {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-nav li {
            margin-bottom: 5px;
        }
        
        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            color: #fff;
            background: rgba(76, 175, 80, 0.1);
            border-right: 3px solid #4CAF50;
        }
        
        .sidebar-nav a i {
            margin-right: 12px;
            font-size: 1.2rem;
            width: 24px;
        }
        
        .stat-card {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .stat-card .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-card .stat-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }
        
        .stat-card .stat-change {
            font-size: 0.85rem;
            margin-top: 10px;
        }
        
        .stat-card.primary { border-left: 4px solid #4CAF50; }
        .stat-card.info { border-left: 4px solid #2196F3; }
        .stat-card.warning { border-left: 4px solid #FF9800; }
        .stat-card.danger { border-left: 4px solid #F44336; }
        .stat-card.success { border-left: 4px solid #8BC34A; }
        
        .icon-primary { background: rgba(76, 175, 80, 0.1); color: #4CAF50; }
        .icon-info { background: rgba(33, 150, 243, 0.1); color: #2196F3; }
        .icon-warning { background: rgba(255, 152, 0, 0.1); color: #FF9800; }
        .icon-danger { background: rgba(244, 67, 54, 0.1); color: #F44336; }
        .icon-success { background: rgba(139, 195, 74, 0.1); color: #8BC34A; }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #fff;
        }
        
        .quick-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        
        .quick-action-btn {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: #4CAF50;
            padding: 15px 25px;
            border-radius: 10px;
            text-decoration: none;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quick-action-btn:hover {
            background: rgba(76, 175, 80, 0.2);
            transform: translateY(-2px);
            color: #4CAF50;
        }
        
        .activity-feed {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
        }
        
        .table-dark {
            background: rgba(26, 26, 46, 0.6);
        }
        
        .badge-custom {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .progress-bar-custom {
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .filter-bar {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .filter-bar select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 8px 15px;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="admin-sidebar">
        <div class="sidebar-brand">
            <h4 class="text-white mb-0"><i class="bi bi-activity"></i> AutopsyLoop</h4>
            <small class="text-muted">Learning & Analytics</small>
        </div>
        
        <ul class="sidebar-nav">
            <li><a href="{% url 'autopsy:dashboard' %}" class="active"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
            <li><a href="#" data-section="audits"><i class="bi bi-clipboard-check"></i> Audits</a></li>
            <li><a href="#" data-section="rca"><i class="bi bi-bug"></i> Root Causes</a></li>
            <li><a href="#" data-section="jobs"><i class="bi bi-gear-fill"></i> Jobs</a></li>
            <li><a href="#" data-section="rules"><i class="bi bi-rulers"></i> Labeling Rules</a></li>
            
            <li style="margin-top: 20px; padding: 10px 20px;">
                <small class="text-muted text-uppercase">System</small>
            </li>
            
            <li><a href="/admin-dashboard/"><i class="bi bi-shield-check"></i> Admin Panel</a></li>
            <li><a href="{% url 'signals:dashboard' %}"><i class="bi bi-house-door"></i> Main Dashboard</a></li>
            <li><a href="/admin/logout/"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
        </ul>
    </div>
    
    <!-- Main Content -->
    <div class="admin-content">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="text-white mb-0">AutopsyLoop Analytics</h2>
                <small class="text-muted">Automated retrospective analysis & learning system</small>
            </div>
            <div>
                <span class="text-muted me-3">{{ request.user.email }}</span>
                <span class="badge bg-success">Active</span>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="#" class="quick-action-btn" onclick="runAutopsy(); return false;">
                <i class="bi bi-play-circle"></i> Run Analysis
            </a>
            <a href="#" class="quick-action-btn" data-section="rules">
                <i class="bi bi-rulers"></i> Configure Rules
            </a>
            <a href="#" class="quick-action-btn" data-section="jobs">
                <i class="bi bi-clock-history"></i> View Jobs
            </a>
            <a href="#export-data" class="quick-action-btn">
                <i class="bi bi-download"></i> Export Data
            </a>
        </div>
        
        <!-- Time Filter -->
        <div class="filter-bar">
            <span class="text-white"><i class="bi bi-calendar3"></i> Time Range:</span>
            <select id="timeFilter" onchange="window.location.href='?days='+this.value">
                <option value="1" {% if days == 1 %}selected{% endif %}>Last 24 Hours</option>
                <option value="7" {% if days == 7 %}selected{% endif %}>Last 7 Days</option>
                <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 Days</option>
                <option value="90" {% if days == 90 %}selected{% endif %}>Last 90 Days</option>
            </select>
            <span class="ms-auto text-muted">
                <i class="bi bi-info-circle"></i> Showing {{ total_audits }} audits from last {{ days }} days
            </span>
        </div>
        
        <!-- Overview Stats -->
        <h3 class="section-title"><i class="bi bi-graph-up"></i> System Overview</h3>
        <div class="row">
            <div class="col-md-3">
                <div class="stat-card primary">
                    <div class="stat-icon icon-primary">
                        <i class="bi bi-clipboard-data"></i>
                    </div>
                    <div class="stat-value">{{ total_audits }}</div>
                    <div class="stat-label">Total Audits</div>
                    <div class="stat-change text-success">
                        <i class="bi bi-arrow-up"></i> Last {{ days }} days
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="stat-card info">
                    <div class="stat-icon icon-info">
                        <i class="bi bi-broadcast"></i>
                    </div>
                    <div class="stat-value">{{ total_signals }}</div>
                    <div class="stat-label">Available Insights</div>
                    <div class="stat-change text-info">
                        Ready for analysis
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="stat-card success">
                    <div class="stat-icon icon-success">
                        <i class="bi bi-database"></i>
                    </div>
                    <div class="stat-value">{{ total_candles|floatformat:0 }}</div>
                    <div class="stat-label">OHLCV Candles</div>
                    <div class="stat-change">
                        Historical data points
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="stat-card {% if outcomes|length > 0 %}warning{% else %}danger{% endif %}">
                    <div class="stat-icon {% if outcomes|length > 0 %}icon-warning{% else %}icon-danger{% endif %}">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="stat-value">{{ outcomes|length }}</div>
                    <div class="stat-label">Outcome Types</div>
                    <div class="stat-change">
                        Classification results
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Outcome Distribution -->
        <h3 class="section-title"><i class="bi bi-pie-chart"></i> Outcome Distribution</h3>
        <div class="row">
            {% for outcome in outcomes %}
            <div class="col-md-4">
                <div class="stat-card {% if outcome.outcome == 'succeeded' %}success{% elif outcome.outcome == 'failed' %}danger{% else %}warning{% endif %}">
                    <div class="stat-icon {% if outcome.outcome == 'succeeded' %}icon-success{% elif outcome.outcome == 'failed' %}icon-danger{% else %}icon-warning{% endif %}">
                        <i class="bi {% if outcome.outcome == 'succeeded' %}bi-check-circle{% elif outcome.outcome == 'failed' %}bi-x-circle{% else %}bi-dash-circle{% endif %}"></i>
                    </div>
                    <div class="stat-value">{{ outcome.count }}</div>
                    <div class="stat-label">{{ outcome.outcome|title }}</div>
                    <div class="stat-change">
                        {% widthratio outcome.count total_audits 100 %}% of total
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <div class="activity-feed text-center py-4">
                    <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="text-muted mt-3">No outcome data available for this period</p>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Strategy Performance -->
        <h3 class="section-title"><i class="bi bi-diagram-3"></i> Strategy Performance</h3>
        <div class="activity-feed">
            <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>Strategy</th>
                            <th>Total Trades</th>
                            <th>Success Rate</th>
                            <th>Avg P&L</th>
                            <th>Avg Drawdown</th>
                            <th>Performance</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in strategy_stats %}
                        <tr>
                            <td>
                                <a href="{% url 'autopsy:strategy_detail' stat.insight__strategy %}" class="text-info text-decoration-none">
                                    {{ stat.insight__strategy|truncatewords:4 }}
                                </a>
                            </td>
                            <td>{{ stat.total }}</td>
                            <td>
                                <span class="badge badge-custom {% if stat.success_rate >= 60 %}bg-success{% elif stat.success_rate >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                    {{ stat.success_rate|floatformat:1 }}%
                                </span>
                            </td>
                            <td class="{% if stat.avg_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ stat.avg_pnl|default:0|floatformat:2 }}%
                            </td>
                            <td class="text-warning">
                                {{ stat.avg_drawdown|default:0|floatformat:2 }}%
                            </td>
                            <td>
                                <div class="progress-bar-custom" style="width: 150px;">
                                    <div class="progress-fill {% if stat.success_rate >= 60 %}bg-success{% elif stat.success_rate >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                         style="width: {{ stat.success_rate }}%"></div>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">No strategy performance data available</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Root Cause Analysis -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="activity-feed">
                    <h5 class="mb-3"><i class="bi bi-bug"></i> Top Failure Causes</h5>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Root Cause</th>
                                    <th>Count</th>
                                    <th>Avg Confidence</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cause in rca_causes %}
                                <tr>
                                    <td>{{ cause.cause_display }}</td>
                                    <td>
                                        <span class="badge badge-custom bg-danger">{{ cause.count }}</span>
                                    </td>
                                    <td>
                                        <div class="progress-bar-custom" style="width: 100px;">
                                            <div class="progress-fill bg-info" style="width: {{ cause.avg_confidence }}%"></div>
                                        </div>
                                        <small class="text-muted ms-2">{{ cause.avg_confidence|floatformat:0 }}%</small>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No RCA data available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="activity-feed">
                    <h5 class="mb-3"><i class="bi bi-clock-history"></i> Recent Audits</h5>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Outcome</th>
                                    <th>P&L</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for audit in recent_audits|slice:":10" %}
                                <tr>
                                    <td>{{ audit.insight.symbol }}</td>
                                    <td>
                                        <span class="badge badge-custom {% if audit.outcome == 'succeeded' %}bg-success{% elif audit.outcome == 'failed' %}bg-danger{% else %}bg-warning{% endif %}">
                                            {{ audit.outcome }}
                                        </span>
                                    </td>
                                    <td class="{% if audit.pnl_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                                        {% if audit.pnl_pct %}{{ audit.pnl_pct|floatformat:2 }}%{% else %}-{% endif %}
                                    </td>
                                    <td>{{ audit.created_at|timesince }} ago</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No recent audits</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Jobs -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="activity-feed">
                    <h5 class="mb-3"><i class="bi bi-gear-fill"></i> Recent Analysis Jobs</h5>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Job ID</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Total Insights</th>
                                    <th>Started</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for job in recent_jobs %}
                                <tr>
                                    <td><code>{{ job.job_id|truncatechars:12 }}</code></td>
                                    <td>
                                        <span class="badge badge-custom {% if job.status == 'completed' %}bg-success{% elif job.status == 'running' %}bg-info{% elif job.status == 'failed' %}bg-danger{% else %}bg-warning{% endif %}">
                                            {{ job.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="progress-bar-custom" style="width: 150px;">
                                            {% if job.total_insights > 0 %}
                                                {% widthratio job.completed_audits job.total_insights 100 as progress %}
                                                <div class="progress-fill bg-success" style="width: {{ progress }}%"></div>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted ms-2">{{ job.completed_audits }}/{{ job.total_insights }}</small>
                                    </td>
                                    <td>{{ job.total_insights }}</td>
                                    <td>{{ job.started_at|timesince }} ago</td>
                                    <td>
                                        {% if job.finished_at and job.started_at %}
                                            {% with duration=job.finished_at|timeuntil:job.started_at %}
                                                {{ duration }}
                                            {% endwith %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No recent jobs</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function runAutopsy() {
            if (confirm('Run AutopsyLoop analysis on available insights?\n\nThis will:\n- Analyze recent trade insights\n- Label outcomes (succeeded/failed/neutral)\n- Perform root cause analysis\n- Generate explanations\n\nContinue?')) {
                alert('Analysis job queued!\n\nThis feature requires CLI command:\npython manage.py run_autopsy --last-days 7 --horizons 4H,24H');
            }
        }
        
        // Section navigation (for future implementation)
        document.querySelectorAll('[data-section]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.currentTarget.dataset.section;
                alert(`Navigation to ${section} section coming soon!\n\nFor now, use Django admin:\n/admin/autopsy/`);
            });
        });
    </script>
</body>
</html>

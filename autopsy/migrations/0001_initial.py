# Generated by Django 4.2.7 on 2025-11-12 21:18

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('signals', '0016_rename_signals_mar_receive_idx_signals_mar_receive_ff78a5_idx_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='ModelVersion',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('version_id', models.CharField(db_index=True, max_length=100, unique=True)),
                ('strategy', models.CharField(db_index=True, max_length=100)),
                ('model_type', models.CharField(help_text='e.g., RandomForest, XGBoost', max_length=50)),
                ('model_path', models.CharField(help_text='Path to serialized model', max_length=500)),
                ('config', models.JSONField(default=dict, help_text='Hyperparameters and configuration')),
                ('dataset_path', models.CharField(max_length=500)),
                ('dataset_size', models.IntegerField(help_text='Number of training samples')),
                ('train_date_from', models.DateTimeField(blank=True, null=True)),
                ('train_date_to', models.DateTimeField(blank=True, null=True)),
                ('metrics', models.JSONField(default=dict, help_text='Accuracy, precision, recall, F1, etc.')),
                ('validation_metrics', models.JSONField(blank=True, default=dict)),
                ('feature_importance', models.JSONField(blank=True, default=dict)),
                ('is_active', models.BooleanField(db_index=True, default=False)),
                ('is_production', models.BooleanField(db_index=True, default=False)),
                ('notes', models.TextField(blank=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('trained_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Model Version',
                'verbose_name_plural': 'Model Versions',
                'db_table': 'autopsy_modelversion',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='LabelingRule',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('strategy', models.CharField(blank=True, help_text='Apply to specific strategy (blank = all)', max_length=100)),
                ('symbol', models.CharField(blank=True, help_text='Apply to specific symbol (blank = all)', max_length=20)),
                ('timeframe', models.CharField(blank=True, max_length=10)),
                ('horizon', models.CharField(help_text='e.g., 1H, 4H, 24H', max_length=10)),
                ('success_tp_pips', models.DecimalField(blank=True, decimal_places=2, help_text='Price must move this many pips in favor', max_digits=8, null=True)),
                ('success_rr_ratio', models.DecimalField(blank=True, decimal_places=2, help_text='Risk:Reward ratio (e.g., 2.0 = 1:2)', max_digits=5, null=True)),
                ('fail_sl_pips', models.DecimalField(blank=True, decimal_places=2, help_text='Stop loss threshold', max_digits=8, null=True)),
                ('fail_adverse_pct', models.DecimalField(blank=True, decimal_places=2, help_text='Max adverse move percentage', max_digits=5, null=True)),
                ('neutral_band_pips', models.DecimalField(decimal_places=2, default=10, help_text='Price movement within this = neutral', max_digits=8)),
                ('is_active', models.BooleanField(db_index=True, default=True)),
                ('priority', models.IntegerField(default=100, help_text='Higher = applied first')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('notes', models.TextField(blank=True)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Labeling Rule',
                'verbose_name_plural': 'Labeling Rules',
                'db_table': 'autopsy_labelingrule',
                'ordering': ['-priority', '-created_at'],
            },
        ),
        migrations.CreateModel(
            name='InsightAudit',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('evaluated_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('horizon', models.CharField(help_text='Evaluation timeframe (1H, 4H, 24H, 7D)', max_length=10)),
                ('outcome', models.CharField(choices=[('succeeded', 'Succeeded'), ('failed', 'Failed'), ('neutral', 'Neutral'), ('filtered_out', 'Filtered Out'), ('pending', 'Pending Evaluation'), ('needs_review', 'Needs Manual Review')], db_index=True, default='pending', max_length=20)),
                ('pnl_pct', models.DecimalField(blank=True, decimal_places=4, help_text='Realized P&L percentage', max_digits=10, null=True)),
                ('max_drawdown', models.DecimalField(blank=True, decimal_places=4, help_text='Maximum adverse move during evaluation', max_digits=10, null=True)),
                ('duration_minutes', models.IntegerField(blank=True, help_text='Time to outcome', null=True)),
                ('entry_price', models.DecimalField(blank=True, decimal_places=5, max_digits=20, null=True)),
                ('exit_price', models.DecimalField(blank=True, decimal_places=5, max_digits=20, null=True)),
                ('high_price', models.DecimalField(blank=True, decimal_places=5, max_digits=20, null=True)),
                ('low_price', models.DecimalField(blank=True, decimal_places=5, max_digits=20, null=True)),
                ('risk_reward_actual', models.DecimalField(blank=True, decimal_places=2, max_digits=6, null=True)),
                ('slippage_pips', models.DecimalField(blank=True, decimal_places=2, max_digits=8, null=True)),
                ('user_acted', models.BooleanField(default=False, help_text='User actually took this trade')),
                ('replay_verified', models.BooleanField(default=False, help_text='Pattern re-detected in replay')),
                ('needs_manual_review', models.BooleanField(db_index=True, default=False)),
                ('reviewed_at', models.DateTimeField(blank=True, null=True)),
                ('reviewer_notes', models.TextField(blank=True)),
                ('replay_snapshot', models.JSONField(default=dict, help_text='OHLCV data at evaluation time')),
                ('config_snapshot', models.JSONField(default=dict, help_text='Labeling rules used')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('insight', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='audits', to='signals.signal')),
                ('reviewer', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='audits_reviewed', to=settings.AUTH_USER_MODEL)),
                ('user', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Insight Audit',
                'verbose_name_plural': 'Insight Audits',
                'db_table': 'autopsy_insightaudit',
                'ordering': ['-evaluated_at'],
            },
        ),
        migrations.CreateModel(
            name='AutopsyJob',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('job_id', models.CharField(db_index=True, max_length=100, unique=True)),
                ('insight_ids', models.JSONField(default=list, help_text='List of Signal IDs to audit')),
                ('from_date', models.DateTimeField(blank=True, null=True)),
                ('to_date', models.DateTimeField(blank=True, null=True)),
                ('horizons', models.JSONField(default=list, help_text="e.g., ['1H', '4H', '24H']")),
                ('params', models.JSONField(default=dict, help_text='Labeling rules and thresholds')),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('running', 'Running'), ('completed', 'Completed'), ('failed', 'Failed'), ('cancelled', 'Cancelled')], db_index=True, default='pending', max_length=20)),
                ('started_at', models.DateTimeField(blank=True, null=True)),
                ('finished_at', models.DateTimeField(blank=True, null=True)),
                ('total_insights', models.IntegerField(default=0)),
                ('completed_audits', models.IntegerField(default=0)),
                ('failed_audits', models.IntegerField(default=0)),
                ('error_message', models.TextField(blank=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('requested_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Autopsy Job',
                'verbose_name_plural': 'Autopsy Jobs',
                'db_table': 'autopsy_autopsyjob',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='AuditRCA',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('cause', models.CharField(choices=[('model_error', 'Model Error'), ('regime_drift', 'Regime Drift'), ('news_shock', 'News Shock'), ('liquidity_event', 'Liquidity Event'), ('detector_misid', 'Detector Mis-identification'), ('user_psychology', 'User Psychology Effect'), ('volatility_spike', 'Volatility Spike'), ('spread_slippage', 'Spread/Slippage'), ('false_positive', 'False Positive Pattern'), ('external_shock', 'External Market Shock'), ('unknown', 'Unknown')], db_index=True, max_length=30)),
                ('confidence', models.DecimalField(decimal_places=2, help_text='0-100 confidence score', max_digits=5)),
                ('rank', models.IntegerField(help_text='Ranking among all causes (1=primary)')),
                ('evidence', models.JSONField(default=dict, help_text='Structured evidence data')),
                ('summary', models.TextField(help_text='Human-readable summary of why this cause applies')),
                ('explain_shap', models.JSONField(blank=True, default=dict, help_text='SHAP values if model-related')),
                ('news_references', models.JSONField(blank=True, default=list, help_text='Related NewsEvent IDs')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('audit', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='root_causes', to='autopsy.insightaudit')),
            ],
            options={
                'verbose_name': 'Audit Root Cause',
                'verbose_name_plural': 'Audit Root Causes',
                'db_table': 'autopsy_auditrca',
                'ordering': ['audit', 'rank'],
            },
        ),
        migrations.CreateModel(
            name='RetrainRequest',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('request_id', models.CharField(db_index=True, max_length=100, unique=True)),
                ('strategy', models.CharField(help_text='Strategy or model to retrain', max_length=100)),
                ('dataset_path', models.CharField(help_text='Path to training dataset', max_length=500)),
                ('audit_count', models.IntegerField(default=0, help_text='Number of audits in dataset')),
                ('reason', models.TextField(help_text='Why retraining is needed')),
                ('suggested_changes', models.JSONField(default=list, help_text='Specific suggestions')),
                ('status', models.CharField(choices=[('requested', 'Requested'), ('simulating', 'Simulating Uplift'), ('pending_approval', 'Pending Approval'), ('approved', 'Approved'), ('training', 'Training'), ('completed', 'Completed'), ('rejected', 'Rejected'), ('rolled_back', 'Rolled Back')], db_index=True, default='requested', max_length=20)),
                ('metrics_before', models.JSONField(default=dict, help_text='Current model performance')),
                ('metrics_after_simulation', models.JSONField(blank=True, default=dict, help_text='Simulated performance after retrain')),
                ('metrics_after_production', models.JSONField(blank=True, default=dict, help_text='Actual performance in production')),
                ('reviewed_at', models.DateTimeField(blank=True, null=True)),
                ('reviewer_notes', models.TextField(blank=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('new_model_version', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='retrain_to', to='autopsy.modelversion')),
                ('old_model_version', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='retrain_from', to='autopsy.modelversion')),
                ('requested_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='retrain_requests', to=settings.AUTH_USER_MODEL)),
                ('reviewed_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='retrain_reviews', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Retrain Request',
                'verbose_name_plural': 'Retrain Requests',
                'db_table': 'autopsy_retrainrequest',
                'ordering': ['-created_at'],
                'indexes': [models.Index(fields=['status', '-created_at'], name='autopsy_ret_status_305167_idx'), models.Index(fields=['strategy', '-created_at'], name='autopsy_ret_strateg_1488f4_idx')],
            },
        ),
        migrations.AddIndex(
            model_name='modelversion',
            index=models.Index(fields=['strategy', '-created_at'], name='autopsy_mod_strateg_34e15f_idx'),
        ),
        migrations.AddIndex(
            model_name='modelversion',
            index=models.Index(fields=['is_production', 'strategy'], name='autopsy_mod_is_prod_30e85c_idx'),
        ),
        migrations.AddIndex(
            model_name='labelingrule',
            index=models.Index(fields=['is_active', '-priority'], name='autopsy_lab_is_acti_4d87b2_idx'),
        ),
        migrations.AddIndex(
            model_name='labelingrule',
            index=models.Index(fields=['strategy', 'symbol', 'timeframe'], name='autopsy_lab_strateg_4632b5_idx'),
        ),
        migrations.AddIndex(
            model_name='insightaudit',
            index=models.Index(fields=['insight', 'horizon'], name='autopsy_ins_insight_282979_idx'),
        ),
        migrations.AddIndex(
            model_name='insightaudit',
            index=models.Index(fields=['outcome', '-evaluated_at'], name='autopsy_ins_outcome_3b38db_idx'),
        ),
        migrations.AddIndex(
            model_name='insightaudit',
            index=models.Index(fields=['user', '-evaluated_at'], name='autopsy_ins_user_id_516d0c_idx'),
        ),
        migrations.AddIndex(
            model_name='insightaudit',
            index=models.Index(fields=['needs_manual_review', '-evaluated_at'], name='autopsy_ins_needs_m_51c9c3_idx'),
        ),
        migrations.AddIndex(
            model_name='autopsyjob',
            index=models.Index(fields=['status', '-created_at'], name='autopsy_aut_status_3b07f4_idx'),
        ),
        migrations.AddIndex(
            model_name='autopsyjob',
            index=models.Index(fields=['job_id'], name='autopsy_aut_job_id_20bd30_idx'),
        ),
        migrations.AddIndex(
            model_name='auditrca',
            index=models.Index(fields=['audit', 'rank'], name='autopsy_aud_audit_i_021f9b_idx'),
        ),
        migrations.AddIndex(
            model_name='auditrca',
            index=models.Index(fields=['cause', '-confidence'], name='autopsy_aud_cause_916282_idx'),
        ),
    ]
